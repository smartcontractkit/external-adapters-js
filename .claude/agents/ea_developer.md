# Chainlink External Adapters (EAs) Development Guide

## 1.GOAL

Create an EA according to the specifications in the requirements YAML provided by the user by following this developement guide step by step

CRITICAL: FOLLOWING REQUIREMENTS ARE REQUIRED AND MUST FOLLOW

- ALL SPECIFIACTIONS IN THE YAML REQUIREMENT MUST BE STRICTLY IMPLEMENTED AS REQUESTED
- prioritize readable, maintainable tests over comprehensive coverage

## 2. TODO LIST

- [] Analyze and read provided requirement YAML and this development guide
- [] Setup the EA Folder Structure with Required Commands
- [] Create Transports
- [] Create Endpoints
- [] Create Adapters
- [] Setup Config
- [] Additional Necessary Items ...

## 3. Example EA Request and Response format

Follow the requested schemas and format of EA request and response provided in the yaml requirements.

### Example Request Format (EA Invocation)

```json
{
  "data": {
    "endpoint": "nav",
    "ticker": "WTGXX",
    "transport": "rest"
  }
}
```

### Example Response Format (EA Response)

```json
{
  "data": {
    "result": 1
  },
  "result": 1,
  "statusCode": 200,
  "timestamps": {
    "providerDataRequestedUnixMs": 978347471111,
    "providerDataReceivedUnixMs": 978347471111,
    "providerIndicatedTimeUnixMs": 1750204800000
  }
}
```

---

## 4. Development Walkthrough - New Source EA

### Prerequisites

- Node.js 22
- Yarn

### Step 1: Setup the EA Folder Structure with Required Commands

CRITICAL:MUST USE FOLLOWING REQUIRED COMMAND to copy the EA folder structure from the ea-agent/package-template

#### 1.setup
```bash
yarn install
yarn setup
```

#### 2.create the package
```bash
yarn new source
```

#### 3.execute the yo command generated by the previous step
use 
```bash
EXTERNAL_ADAPTER_GENERATOR_NO_INTERACTIVE=true [yo command]
```
ignore `yarn new tsconfig` for now because we need to rename the example-adapter first

#### 4.rename the folder from `example-adapter` to requested adpater name
```bash
mv packages/sources/example-adapter packages/sources/[requested-adapter-name]
```

### 5. execute `yarn new tsconfig`

---

### Step 2: Create Transports

Once the folder structure has been set up, define a transport in the `transport/` folder. The v3 framework provides different transport types for various protocols:

- **HttpTransport** is used to fetch data from a Provider using HTTP requests
- **WebSocketTransport** is used to fetch data from a Provider using Websocket protocol
- **Subscription** is an abstract transport (class) that serves as the foundation for implementing subscription-based transports. This class is intended to be extended by specific transport implementations.
- **StreamingTransport** is an abstract transport (class) that extends the **SubscriptionTransport** and provides a foundation for implementing streaming-based transports.
- **SseTransport** is used to fetch data from a Provider using the SSE (Server-Sent Events) protocol
- **Custom** is when you need custom functionality that is not provided by the built-in transports above, you may need to define custom transport

  **Example 1: Generic HTTP Transport**

```ts
const transport = new HttpTransport<HttpTransportTypes>({
  // Return list of ProviderRequestConfigs
  prepareRequests: (params, config) => {
    return params.map((param) => {
      const symbol = param.symbol.toLowerCase()
      const url = `/price/${symbol}`

      return {
        params: param,
        request: {
          baseURL: config.API_ENDPOINT,
          url,
        },
      }
    })
  },

  // Parse response into individual ProviderResults for each set of params
  parseResponse: (params, res) => {
    return res.data.map((result) => {
      return {
        params: { symbol: result.symbol },
        response: {
          data: {
            result: result.price,
          },
          result: result.price,
        },
      }
    })
  },
})
```

**Example 2: WisdomTree HTTP Transport**

```ts
export const httpTransport = new HttpTransport({
  prepareRequests: (params, config) =>
    params.map((p) => ({
      params: [p],
      request: {
        baseURL: config.API_ENDPOINT,
        url: '/funddetails/nav/',
        headers: { 'x-api-key': config.API_KEY },
      },
    })),

  parseResponse: (params, res) =>
    res.data.map((r) => ({
      params: params[0],
      response: {
        data: { result: r.nav },
      },
    })),
})
```

### Step 3: Create Endpoints

Define the endpoint by referencing the transport created in the previous step.
Following are common enpoints:

- price: Standard price feed endpoint using base/quote inputs and a single-number result.
- por: Proof-of-Reserves endpoint.
- lwba: Lightweight bid/ask endpoint enforcing bid ≤ mid ≤ ask and returning bid/mid/ask.
- nav: Net Asset Value endpoint

**Example 1: Generic Endpoint**

```ts
import { AdapterEndpoint } from '@chainlink/external-adapter-framework/adapter'
import { transport } from '../transport/endpoint'

export const endpoint = new AdapterEndpoint({
  name: 'endpoint', // The name of this endpoint
  transport: transport, // The transport this endpoint retrieves data through
  inputParameters, // Input parameters sent in requests to this endpoint
})
```

**Example 2: WisdomTree NAV Endpoint**

```ts
import { InputParameters, AdapterEndpoint } from '@chainlink/external-adapter-framework/adapter'
import { httpTransport } from '../transport/nav'

export const inputParameters = new InputParameters({
  ticker: {
    aliases: ['symbol', 'fundId'],
    required: true,
    type: 'string',
  },
})

export const endpoint = new AdapterEndpoint({
  name: 'nav',
  transport: httpTransport,
  inputParameters,
})
```

---

### Step 4: Create Adapters

Create the adapter in the `src/index.ts` file, referencing the endpoint(s) created in the previous step.

```ts
import { Adapter, expose } from '@chainlink/external-adapter-framework'
import { endpoint } from './endpoint'

export const adapter = new Adapter({
  name: 'ADAPTER_NAME', // The EA name, in uppercase without spaces
  endpoints: [endpoint], // Array of all endpoints (from endpoints folder)
})

// Expose the server to start the EA
export const server = () => expose(adapter)
```

---

### Step 5: Setup Config

Define configuration settings in `config/index.ts`

The v3 framework allows developers to define env vars that are specific to their EA. They should be defined in the /config/index.ts file in the format below. Set the Rate Limiting Tiers, Overrides, Includes at this step as well

:

```ts
import { AdapterConfig } from '@chainlink/external-adapter-framework/config'

export const config = new AdapterConfig({
  API_ENDPOINT: {
    description: 'Base URL for the API',
    type: 'string',
    default: 'https://dataspanapi.wisdomtree.com',
  },
  API_KEY: {
    description: 'API key for authentication',
    type: 'string',
    required: true,
    sensitive: true,
  },
})
```

---

### Development Tips

- For every implementation, look up if there are similar implementaitons exist in the other deployed EA packages
- Keep **input validation** strict; provide clear error messages
- Prefer **typed responses** (e.g., `SingleNumberResultResponse`) and avoid leaking provider schema
- Include **test-payload.json** for PR soak checks

---

## 6. Best Practices & Common Pitfalls

**Keep It Simple, Stupid**

- Apply KISS principle to code implementation
- Avoid shallow, wrappers of language/framework native functions

**Input Validation**

- Validate inputs rigorously
- Provide helpful, clear error messages

**Output Normalization**

- Normalize outputs consistently
- Avoid provider-specific field leakage
- Prefer typed responses (e.g., `SingleNumberResultResponse`)

**Rate Limiting & Caching**

- Configure appropriate rate limits
- Document limits in README

**Documentation**

- Keep README minimal
- Rely on auto-generated docs

**Reliability**

- Prefer idempotent operations
- Be mindful of retries
- maintain precision tolerance of 18 decimals for on-chain feed

**Naming convention**
clear, readable best practice names

**Common Pattern**
Use https://github.com/MikeMcl/bignumber.js/ when operating on large integers
Use https://github.com/MikeMcl/decimal.js/ for all floating point operations. Decimal.js uses a precision of 20 by default, but we may lose some precision with really large numbers, so please update to a higher precision before usage

**Agent docs**
focus on EA code, DO NOT generate extra markdown to explain/summarize/report the agent behaviour including but not limited to report, summary, result, checklist, etc....
