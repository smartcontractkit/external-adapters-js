# Chainlink External Adapters (EAs) Development Guide

## 1.GOAL

Create an EA according to the specifications in the requirements YAML provided by the user by following this developement guide step by step using the chainlink-external-adapter-framework at @.yarn/unplugged/@chainlink-external-adapter-framework-npm-\*

CRITICAL: FOLLOWING REQUIREMENTS ARE REQUIRED AND MUST FOLLOW

- ALL SPECIFIACTIONS IN THE YAML REQUIREMENT MUST BE STRICTLY IMPLEMENTED AS REQUESTED
- Prioritize readable, maintainable tests over comprehensive coverage
- Use the framework for EA components @.yarn/unplugged/@chainlink-external-adapter-framework-npm-\*

## 2. TODO LIST

- [] Analyze and read provided requirement YAML and this development guide
- [] Setup the EA Folder Structure with Required Commands
- [] Create Transports
- [] Create Endpoints
- [] Create Adapters
- [] Setup Config
- [] Additional Necessary Items ...

## 3. Example EA Request and Response format

Follow the requested schemas and format of EA request and response provided in the yaml requirements.

### Example Request Format (EA Invocation)

```json
{
  "data": {
    "endpoint": "nav",
    "ticker": "WTGXX",
    "transport": "rest"
  }
}
```

### Example Response Format (EA Response)

```json
{
  "data": {
    "result": 1
  },
  "result": 1,
  "statusCode": 200,
  "timestamps": {
    "providerDataRequestedUnixMs": 978347471111,
    "providerDataReceivedUnixMs": 978347471111,
    "providerIndicatedTimeUnixMs": 1750204800000
  }
}
```

---

## 4. Development Walkthrough - New Source EA

### Prerequisites

- Node.js 22
- Yarn

### Step 1: Setup the EA Folder Structure with Required Commands

CRITICAL:MUST USE FOLLOWING REQUIRED COMMANDs

#### 1.create the package

```bash
yarn new source
```

#### 2.execute the yo command generated by the previous step

use

```bash
EXTERNAL_ADAPTER_GENERATOR_NO_INTERACTIVE=true [yo command]
```

ignore `yarn new tsconfig` for now because we need to rename the example-adapter first

#### 3.rename the folder from `example-adapter` to requested adpater name

```bash
mv packages/sources/example-adapter packages/sources/[requested-adapter-name]
```

#### 4. execute `yarn new tsconfig`

---

### Step 2: Create Transports

Define a transport in the `transport/` folder. **Read the framework source for implementation details:**

| Transport Type       | Framework Source                                                                                                                           | Use Case                           |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------- |
| `HttpTransport`      | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/transports/http.d.ts`      | HTTP REST API requests             |
| `WebSocketTransport` | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/transports/websocket.d.ts` | Real-time WebSocket data           |
| `SseTransport`       | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/transports/sse.d.ts`       | Server-Sent Events                 |
| Abstract transports  | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/transports/abstract/`      | Base classes for custom transports |

**Key concepts:**

- `HttpTransport` requires `prepareRequests` and `parseResponse` methods
- `WebSocketTransport` requires `url`, `handlers.message`, and optionally `builders` for subscribe/unsubscribe
- Read the `.d.ts` files for exact type definitions and required config

**Real-world examples:** `packages/sources/coingecko/src/transport/`, `packages/sources/coinpaprika/src/transport/`

---

### Step 3: Create Endpoints

Define endpoints in the `endpoint/` folder. **Read the framework source for endpoint types:**

| Endpoint Type                                                | Framework Source                                                                                                                            | Use Case                            |
| ------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------- |
| `AdapterEndpoint`                                            | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/endpoint.d.ts`      | Generic endpoints                   |
| `PriceEndpoint`, `CryptoPriceEndpoint`, `ForexPriceEndpoint` | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/price.d.ts`         | Price feeds with base/quote params  |
| `LwbaEndpoint`                                               | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/lwba.d.ts`          | Lightweight bid/ask (bid, mid, ask) |
| PoR endpoints                                                | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/por.d.ts`           | Proof of Reserves                   |
| `MarketStatusEndpoint`                                       | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/market-status.d.ts` | Market open/closed status           |
| `StockEndpoint`                                              | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/stock.d.ts`         | Stock data feeds                    |

**Input Parameters:**

| Type                                     | Framework Source                                                                                                                              | Use Case                     |
| ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- |
| `InputParameters`                        | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/validation/input-params.d.ts` | Custom input params          |
| `EmptyInputParameters`                   | Same file as above                                                                                                                            | No input params needed       |
| `priceEndpointInputParametersDefinition` | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/price.d.ts`           | Predefined base/quote params |
| `lwbaEndpointInputParametersDefinition`  | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/lwba.d.ts`            | Predefined LWBA params       |

**Real-world examples:** `packages/sources/coingecko/src/endpoint/`, `packages/sources/wbtc-address-set/src/endpoint/`

---

### Step 4: Create Adapters

Create the adapter in `src/index.ts`. **Read the framework source:**

| Adapter Type   | Framework Source                                                                                                                    | Use Case                          |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| `Adapter`      | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/basic.d.ts` | Generic adapter                   |
| `PriceAdapter` | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/price.d.ts` | Price feeds with includes support |
| `PoRAdapter`   | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/por.d.ts`   | Proof of Reserves                 |
| `expose`       | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/index.d.ts`         | Server startup                    |

**Real-world examples:** `packages/sources/coingecko/src/index.ts`, `packages/sources/wisdomtree/src/index.ts`

---

### Step 5: Setup Config

Define configuration in `config/index.ts`. **Read the framework source:**

| Component       | Framework Source                                                                                                                   |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| `AdapterConfig` | `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/config/index.d.ts` |
| Base settings   | Same file - see `BaseSettingsDefinition` for all available base settings                                                           |

**Config types supported:** `string`, `number`, `boolean`, `enum`

**Real-world examples:** `packages/sources/coingecko/src/config.ts`, `packages/sources/wisdomtree/src/config.ts`

---

### Development Tips

- For every implementation, look up if there are similar implementaitons exist in the other deployed EA packages
- Keep **input validation** strict; provide clear error messages
- Prefer **typed responses** (e.g., `SingleNumberResultResponse`) and avoid leaking provider schema
- Include **test-payload.json** for PR soak checks

---

## 6. Best Practices & Common Pitfalls

**Keep It Simple, Stupid**

- Apply KISS principle to code implementation
- Avoid shallow, wrappers of language/framework native functions

**Input Validation**

- Validate inputs rigorously
- Provide helpful, clear error messages

**Output Normalization**

- Normalize outputs consistently
- Avoid provider-specific field leakage
- Prefer typed responses (e.g., `SingleNumberResultResponse`)

**Rate Limiting & Caching**

- Configure appropriate rate limits
- Document limits in README

**Documentation**

- Keep README minimal
- Rely on auto-generated docs

**Reliability**

- Prefer idempotent operations
- Be mindful of retries
- maintain precision tolerance of 18 decimals for on-chain feed

**Naming convention**
clear, readable best practice names

**Common Pattern**
Use https://github.com/MikeMcl/bignumber.js/ when operating on large integers
Use https://github.com/MikeMcl/decimal.js/ for all floating point operations. Decimal.js uses a precision of 20 by default, but we may lose some precision with really large numbers, so please update to a higher precision before usage

**Native JS Packages**

Use native JS packages when the framework doesn't provide the needed functionality:

| Use Case              | Package                     | When to Use                                                            |
| --------------------- | --------------------------- | ---------------------------------------------------------------------- |
| EVM on-chain reads    | `ethers`                    | Reading smart contracts, calling view functions, encoding/decoding ABI |
| Solana on-chain reads | `@solana/web3.js`           | Reading Solana accounts, programs                                      |
| Large integers        | `bignumber.js`              | Handling uint256, token amounts                                        |
| Decimal math          | `decimal.js`                | Precise floating point operations                                      |
| Custom HTTP           | `axios`                     | When HttpTransport doesn't fit (rare)                                  |
| Cryptography          | `crypto` (Node.js built-in) | Signing, hashing for API auth                                          |

**Real-world examples using native packages:**

- `packages/sources/view-function/` - ethers.js for EVM contract calls
- `packages/sources/view-function-multi-chain/` - ethers.js for multi-chain contract reads
- `packages/sources/token-balance/` - ethers.js + @solana/web3.js for token balances
- `packages/sources/uniswap-v2/` - ethers.js for DEX price reads

**Key pattern:** Use native packages within the transport's `prepareRequests`/`parseResponse` or in a custom transport extending `SubscriptionTransport`.

**Agent docs**
focus on EA code, DO NOT generate extra markdown to explain/summarize/report the agent behaviour including but not limited to report, summary, result, checklist, etc....

---

## 7. Framework Reference

### Framework Root

```
.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/
```

### Directory Map

| Directory                  | Contents                    | Key Files                                                                                                                        |
| -------------------------- | --------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| `index.d.ts`               | Main entry point            | `expose`, `start`, `getTLSOptions`                                                                                               |
| `adapter/`                 | Adapters and endpoints      | `basic.d.ts`, `endpoint.d.ts`, `price.d.ts`, `lwba.d.ts`, `por.d.ts`, `market-status.d.ts`, `stock.d.ts`, `types.d.ts`           |
| `transports/`              | Transport implementations   | `http.d.ts`, `websocket.d.ts`, `sse.d.ts`, `metrics.d.ts`, `abstract/` (streaming, subscription)                                 |
| `validation/`              | Input params and validation | `input-params.d.ts` (InputParameters, EmptyInputParameters), `error.d.ts` (AdapterError)                                         |
| `config/`                  | Config and settings         | `index.d.ts` (AdapterConfig, BaseSettingsDefinition)                                                                             |
| `util/`                    | Utilities and types         | `types.d.ts` (SingleNumberResultResponse), `logger.d.ts`, `requester.d.ts`, `testing-utils.d.ts`, `subscription-set/`, `censor/` |
| `cache/`                   | Cache implementations       | `local.d.ts`, `redis.d.ts`, `response.d.ts`, `factory.d.ts`                                                                      |
| `rate-limiting/`           | Rate limiting               | `burst.d.ts`, `fixed-interval.d.ts`, `factory.d.ts`                                                                              |
| `metrics/`                 | Prometheus metrics          | `index.d.ts`, `constants.d.ts`, `util.d.ts`                                                                                      |
| `background-executor.d.ts` | Background execution        | Background task runner                                                                                                           |
| `debug/`                   | Debug endpoints             | `router.d.ts`, `settings-page.d.ts`                                                                                              |
| `status/`                  | Status endpoint             | `router.d.ts`                                                                                                                    |

### Response Types

Read `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/util/types.d.ts` for:

- `SingleNumberResultResponse`
- `AdapterResponse`
- `ProviderResult`
- `ResponseTimestamps`

Read `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/por.d.ts` for:

- `PoRProviderResponse`
- `PoRAddressResponse`
- `PoRBalanceResponse`

Read `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/adapter/lwba.d.ts` for:

- `LwbaResponseDataFields`

### Real-World Examples

| Pattern             | Example Packages                                                           |
| ------------------- | -------------------------------------------------------------------------- |
| HTTP Transport      | `packages/sources/coingecko/`, `packages/sources/coinpaprika/`             |
| WebSocket Transport | `packages/sources/ncfx/`, `packages/sources/tiingo/`                       |
| Empty Input Params  | `packages/sources/wbtc-address-set/`, `packages/sources/the-network-firm/` |
| Price Endpoint      | `packages/sources/coingecko/`, `packages/sources/cryptocompare/`           |
| LWBA Endpoint       | `packages/sources/ncfx/`, `packages/sources/gsr/`                          |
| PoR Endpoints       | `packages/sources/the-network-firm/`, `packages/sources/wbtc-address-set/` |

### Error Handling

Read `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/validation/error.d.ts` for:

- `AdapterError` - Base error class
- `AdapterInputError` - Input validation errors
- `AdapterRateLimitError` - Rate limit errors
- `AdapterDataProviderError` - Provider errors

### Testing Utilities

Read `.yarn/unplugged/@chainlink-external-adapter-framework-npm-*/node_modules/@chainlink/external-adapter-framework/util/testing-utils.d.ts` for test helpers.

### How to Use

1. **Read the `.d.ts` files** in the framework directory to understand types and interfaces
2. **Search existing EAs** in `packages/sources/` for implementation patterns
3. **Use grep** to find usage patterns: `grep -r "HttpTransport" packages/sources/`
