# This action acts as a signal dispatcher that fires whenever the release process has
# successfully completed. The listening workflow within the infra-k8s repository has
# a corresponding event handler to generate releases based on this signal
name: Deploy

on:
  workflow_dispatch:
    inputs:
      selected-adapters:
        description: comma (and/or space) separated list of adapter names to deploy (e.g. "onre, coingecko")
        required: true
  # TEMP: Remove after testing - allows triggering on push to this branch
  push:
    branches:
      - DS-1422-onre-adapter-release-test
    paths:
      - '.github/workflows/deploy-on-demand.yml'

concurrency:
  group: deploy-and-release
  cancel-in-progress: false

jobs:
  parse-adapters:
    name: Parse selected adapters
    runs-on: ubuntu-latest
    outputs:
      adapter-list: ${{ steps.parse.outputs.ADAPTER_LIST }}
    steps:
      - uses: actions/checkout@v5
      - name: Parse adapter input and build matrix
        id: parse
        run: |
          # Convert comma/space separated input to array
          # TEMP: Default to "onre" for push trigger testing
          ADAPTERS="${{ inputs.selected-adapters || 'onre' }}"
          ADAPTERS=$(echo "$ADAPTERS" | tr ',' ' ' | tr -s ' ')

          # Build adapter list JSON
          ADAPTER_JSON='[]'
          for adapter in $ADAPTERS; do
            # Find adapter location (check sources, composites, targets)
            for type in sources composites targets; do
              if [ -d "packages/$type/$adapter" ]; then
                LOCATION="packages/$type/$adapter"
                VERSION=$(jq -r '.version' "$LOCATION/package.json")
                NAME="@chainlink/${adapter}-adapter"
                ADAPTER_JSON=$(echo "$ADAPTER_JSON" | jq -c ". + [{\"name\": \"$NAME\", \"location\": \"$LOCATION\", \"version\": \"$VERSION\", \"shortName\": \"$adapter\"}]")
                break
              fi
            done
          done

          # Output in matrix format
          echo "ADAPTER_LIST={\"adapter\": $ADAPTER_JSON}" >> $GITHUB_OUTPUT

  create-ecr:
    name: Create ECR for ${{ matrix.adapter.shortName }}
    runs-on: ubuntu-latest
    needs: [parse-adapters]
    if: needs.parse-adapters.outputs.adapter-list != '{"adapter":[]}'
    permissions: # These are needed for the configure-aws-credentials action
      id-token: write
      contents: read
    environment: release
    strategy:
      max-parallel: 20
      matrix: ${{ fromJson(needs.parse-adapters.outputs.adapter-list) }}
    env:
      ECR_URL: ${{ secrets.SDLC_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION_ECR_PRIVATE }}.amazonaws.com
      ECR_REPO: adapters/${{ matrix.adapter.shortName }}-adapter
      IMAGE_VERSION: ${{ matrix.adapter.version }}
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
      - name: Create ECR for ${{ matrix.adapter.shortName }}
        uses: ./.github/actions/create-ecrs
        with:
          aws-ecr-url: ${{ env.ECR_URL }}
          aws-ecr-repo: ${{ env.ECR_REPO }}
          aws-region: ${{ secrets.AWS_REGION_ECR_PRIVATE }}
          aws-role: ${{ secrets.AWS_OIDC_IAM_ROLE_ARN }}
          aws-ecr-account-ids: ${{ secrets.AWS_PRIVATE_ECR_SECONDARY_ACCOUNT_ACCESS_IDS }}
          aws-ecr-private: true

  build-publish:
    name: Build and publish ${{ matrix.adapter.shortName }}
    permissions:
      contents: read
      id-token: write
    needs: [parse-adapters, create-ecr]
    strategy:
      max-parallel: 20
      matrix: ${{ fromJson(needs.parse-adapters.outputs.adapter-list) }}
    uses: smartcontractkit/.github/.github/workflows/reusable-docker-build-publish.yml@ce87497eb287565c796a8a781508be949f3ed1e2 # 2025-10-10
    with:
      aws-ecr-name: adapters/${{ matrix.adapter.shortName }}-adapter
      aws-region-ecr: us-west-2
      dockerfile: ./Dockerfile
      docker-build-args: |
        package=${{ matrix.adapter.name }}
        location=${{ matrix.adapter.location }}
      docker-build-context: .
      docker-image-tag-override: ${{ matrix.adapter.version }}
      docker-manifest-additional-tags: latest
      docker-push: true
      environment: release
      git-sha: ${{ github.sha }}
      github-event-name: ${{ github.event_name }}
      github-ref-name: ${{ github.ref_name }}
      github-ref-type: ${{ github.ref_type}}
      github-workflow-repository: ${{ github.repository }}
      github-runner-arm64: ubuntu-24.04-2cores-8GB-ARM
      github-runner-amd64: ubuntu-24.04
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.SDLC_ACCOUNT_ID }}
      AWS_ROLE_PUBLISH_ARN: ${{ secrets.AWS_OIDC_IAM_ROLE_ARN }}

  deploy:
    name: Trigger infra deployment
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    needs:
      - parse-adapters
      - build-publish
    if: needs.parse-adapters.outputs.adapter-list != '{"adapter":[]}'
    environment: InfraK8s
    env:
      ECR_URL: ${{ secrets.SDLC_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION_ECR_PRIVATE }}.amazonaws.com
      CHANGED_ADAPTERS: ${{ needs.parse-adapters.outputs.adapter-list }}
    steps:
      - name: Setup GitHub Token
        id: setup-github-token
        uses: smartcontractkit/.github/actions/setup-github-token@9e7cc0779934cae4a9028b8588c9adb64d8ce68c # setup-github-token@0.1.2
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN_FOR_INFRA_K8s_PAT }}
          aws-lambda-url: ${{ secrets.GATI_LAMBDA_DATA_FEEDS_URL }}
          aws-region: ${{ secrets.AWS_REGION }}
          aws-role-duration-seconds: '1800' # this is optional and defaults to 900
      - name: Trigger Image Dispatcher
        # gitRepo does not need to be an actual repo name. It is only used
        # in the branch name, PR title, and PR description in infra-k8s.
        # We add the GITHUB_SHA as a suffix to allow multiple deployments to be
        # in progress at the same time.
        run: >
          gh workflow run
          --repo smartcontractkit/infra-k8s
          --ref main "Infra-k8s Image Dispatcher"
          -F imageRepos="$(echo $CHANGED_ADAPTERS | jq -r "\"$ECR_URL/adapters/\" + (.adapter | .[].shortName) + \"-adapter\"" | tr '\n' ' ')"
          -F gitRepo=${{ github.event.repository.name }}-${GITHUB_SHA::8}
        env:
          GITHUB_TOKEN: ${{ steps.setup-github-token.outputs.access-token }}
