# Workflow: Triggers when a PR contains YAML in ea-agent/requests
# This is decoupled from JIRA - can be triggered by:
#   1. JIRA (via Workflow 1) - WIP
#   2. Manual PR creation by developer - This workflow
#   3. Comment "/generate-ea" on a PR - This workflow

name: "Generate EA from YAML"

on:
  pull_request:
    types: [opened]
    paths:
      - "ea-agent/requests/**/*.yaml"
      - "ea-agent/requests/**/*.yml"
  issue_comment:
    types: [created]

jobs:
  generate-ea:
    runs-on: ubuntu-latest
    # Run on PR events OR when "/generate-ea" comment is posted on a PR
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/generate-ea'))
    permissions:
      contents: write
      pull-requests: write
      id-token: write # Required for GCP authentication

    steps:
      - name: Check commenter permissions
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });
            if (!['admin', 'write'].includes(permission.permission)) {
              core.setFailed('Only collaborators with write access can trigger this workflow');
            }
            console.log(`User ${context.actor} has ${permission.permission} permission`);

      - name: Get PR details (for comment trigger)
        if: github.event_name == 'issue_comment'
        id: pr
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('number', pr.number);

      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Use SHA for immutable reference (prevents TOCTOU attacks)
          ref: ${{ github.event_name == 'issue_comment' && steps.pr.outputs.head_sha || github.event.pull_request.head.sha }}
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Install uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f # v4

      - name: Set up Python
        uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
        with:
          python-version: "3.11"

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@b7593ed2efd1c1617e1b0254da33b86225adb2a5 # v2.1.12
        with:
          credentials_json: ${{ secrets.CC_GHA_GCP_SERVICE_ACCOUNT_KEY }}
          create_credentials_file: true
          export_environment_variables: true
        env:
          # Ensure credentials are created outside the git repository
          GOOGLE_APPLICATION_CREDENTIALS_FILE_PATH: /tmp/gcp-credentials.json

      - name: Configure environment for Claude Code
        run: |
          echo "CLAUDE_CODE_USE_VERTEX=1" >> $GITHUB_ENV
          echo "CLOUD_ML_REGION=us-east5" >> $GITHUB_ENV
          echo "ANTHROPIC_VERTEX_PROJECT_ID=${{ secrets.CC_GHA_GCP_PROJECT_ID }}" >> $GITHUB_ENV
          echo "DISABLE_PROMPT_CACHING=0" >> $GITHUB_ENV
          echo "DISABLE_TELEMETRY=1" >> $GITHUB_ENV
          echo "DISABLE_ERROR_REPORTING=1" >> $GITHUB_ENV
          echo "DISABLE_BUG_COMMAND=1" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV
          echo "TERM=dumb" >> $GITHUB_ENV
          echo "NO_COLOR=1" >> $GITHUB_ENV
          echo "FORCE_COLOR=0" >> $GITHUB_ENV
          echo "DEBIAN_FRONTEND=noninteractive" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get YAML file from PR
        id: yaml
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            // Determine PR number based on trigger type
            const prNumber = context.eventName === 'issue_comment'
              ? context.issue.number
              : context.payload.pull_request.number;

            // Get all files changed in this PR
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            console.log(`Found ${files.data.length} files in PR`);

            // Find YAML file in ea-requests/
            const yamlFile = files.data.find(f =>
              f.filename.startsWith('ea-requests/') &&
              (f.filename.endsWith('.yaml') || f.filename.endsWith('.yml')) &&
              f.status !== 'removed'
            );

            if (!yamlFile) {
              core.setFailed('No YAML file found in ea-requests/');
              return;
            }

            console.log(`Found YAML file: ${yamlFile.filename}`);

            // Extract JIRA key from filename (e.g., ea-requests/EA-123.yaml -> EA-123)
            const filename = yamlFile.filename.split('/').pop();
            const jiraKey = filename.replace(/\.ya?ml$/, '');

            core.setOutput('file', yamlFile.filename);
            core.setOutput('jira_key', jiraKey);

            console.log(`JIRA Key: ${jiraKey}`);

      - name: Display found YAML
        run: |
          echo "ðŸ“„ YAML File: ${{ steps.yaml.outputs.file }}"
          echo "ðŸŽ« JIRA Key: ${{ steps.yaml.outputs.jira_key }}"
          echo ""
          echo "=== YAML Contents ==="
          cat "${{ steps.yaml.outputs.file }}"

      - name: Install dependencies
        run: |
          uv sync

      - name: Install Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: '22'

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Run EA workflow
        id: ea
        run: |
          echo "ðŸš€ Starting EA generation..."
          uv run python ea_agent.py "${{ steps.yaml.outputs.file }}"

      - name: Check for changes
        id: changes
        run: |
          # Remove any sensitive files that might have been created
          find . -name "gha-creds-*.json" -delete || true
          find . -name "*-credentials.json" -delete || true

          # Check for both modified files and untracked files
          MODIFIED_FILES=$(git diff --name-only)
          UNTRACKED_FILES=$(git ls-files --others --exclude-standard)

          echo "Modified files: $MODIFIED_FILES"
          echo "Untracked files: $UNTRACKED_FILES"

          if [ -z "$MODIFIED_FILES" ] && [ -z "$UNTRACKED_FILES" ]; then
            echo "No changes were made"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Show what files have changed (for debugging)
            echo "Files that changed:"
            git status --porcelain
          fi

      - name: Commit generated code
        if: steps.changes.outputs.has_changes == 'true'
        id: commit
        run: |
          git add -A

          git commit -m "feat(${{ steps.yaml.outputs.jira_key }}): Generated EA code"
          git push
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Changes committed and pushed"

      - name: Update PR description
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const jiraKey = '${{ steps.yaml.outputs.jira_key }}';
            const yamlFile = '${{ steps.yaml.outputs.file }}';
            const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';

            // Determine PR number based on trigger type
            const prNumber = context.eventName === 'issue_comment'
              ? context.issue.number
              : context.payload.pull_request.number;

            const body = `## ðŸ“‹ EA Request

            | Field | Value |
            |-------|-------|
            | **JIRA Issue** | ${jiraKey} |
            | **YAML File** | \`${yamlFile}\` |

            ---

            âœ… **EA Generation Complete!**

            ${hasChanges ? 'Generated code has been committed to this PR.' : 'No new code changes were generated.'}

            ### Review Checklist
            - [ ] Code structure is correct
            - [ ] Tests pass
            - [ ] Configuration is correct
            - [ ] Documentation is adequate

            ---
            _Ready for review and merge._`;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: body
            });

            console.log('âœ… PR description updated');
